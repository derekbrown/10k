{"version":3,"file":"SubscriptionsClient.js","sources":["../../src/SubscriptionsClient.js"],"sourcesContent":["// @flow\n\nimport * as withAbsintheSocket from \"@absinthe/socket\";\nimport {requestFromCompat} from \"@jumpn/utils-graphql\";\nimport {Socket as PhoenixSocket} from \"phoenix\";\n\nimport type {\n  AbsintheSocket,\n  GqlRequest,\n  SubscriptionPayload\n} from \"@absinthe/socket\";\nimport type {GqlRequestCompat} from \"@jumpn/utils-graphql/dist/types\";\nimport type {SocketOpts} from \"phoenix\";\n\ntype SubscriptionCallback = (\n  error: ?Error,\n  payload?: SubscriptionPayload<any>\n) => void;\n\nconst observe = (subscriptionsClient, notifier, callback) =>\n  withAbsintheSocket.observe(subscriptionsClient.absintheSocket, notifier, {\n    onAbort: callback,\n    onResult: result => callback(null, result)\n  });\n\nconst generateRequestKey = subscriptionsClient => {\n  subscriptionsClient.requestsCount += 1;\n\n  return String(subscriptionsClient.requestsCount);\n};\n\nconst storeRequest = (subscriptionsClient, request) => {\n  const requestKey = generateRequestKey(subscriptionsClient);\n\n  subscriptionsClient.requests.set(request, requestKey);\n\n  return requestKey;\n};\n\nconst storeRequestIfNeeded = (subscriptionsClient, request) => {\n  const requestKey = subscriptionsClient.requests.get(request);\n\n  return requestKey !== undefined\n    ? requestKey\n    : storeRequest(subscriptionsClient, request);\n};\n\nconst findNotifier = (subscriptionsClient, request) =>\n  subscriptionsClient.absintheSocket.notifiers.find(\n    notifier => notifier.request === request\n  );\n\n// eslint-disable-next-line consistent-return\nconst findRequest = (subscriptionsClient, requestKey) => {\n  for (const [request, key] of subscriptionsClient.requests.entries()) {\n    if (key === requestKey) return request;\n  }\n};\n\nconst cancel = (subscriptionsClient, notifier) => {\n  withAbsintheSocket.cancel(subscriptionsClient.absintheSocket, notifier);\n\n  subscriptionsClient.requests.delete(notifier.request);\n};\n\nexport default class SubscriptionsClient {\n  absintheSocket: AbsintheSocket;\n\n  requestsCount = 0;\n\n  requests: Map<GqlRequest<any>, string>;\n\n  constructor(socketUrl: string, options: SocketOpts) {\n    this.absintheSocket = withAbsintheSocket.create(\n      new PhoenixSocket(socketUrl, options)\n    );\n\n    this.requests = new Map();\n  }\n\n  close() {\n    this.absintheSocket.phoenixSocket.disconnect();\n  }\n\n  subscribe(\n    requestCompat: GqlRequestCompat<any>,\n    callback: SubscriptionCallback\n  ): string {\n    const notifier = withAbsintheSocket.send(\n      this.absintheSocket,\n      requestFromCompat(requestCompat)\n    );\n\n    const requestKey = storeRequestIfNeeded(this, notifier.request);\n\n    observe(this, notifier, callback);\n\n    return requestKey;\n  }\n\n  unsubscribe(requestKey: string) {\n    const request = findRequest(this, requestKey);\n\n    if (request) {\n      const notifier = findNotifier(this, request);\n\n      if (notifier) cancel(this, notifier);\n    }\n  }\n\n  unsubscribeAll() {\n    this.absintheSocket.notifiers.forEach(notifier => cancel(this, notifier));\n  }\n}\n"],"names":["observe","subscriptionsClient","notifier","callback","withAbsintheSocket","absintheSocket","onAbort","onResult","result","generateRequestKey","requestsCount","String","storeRequest","request","requestKey","requests","set","storeRequestIfNeeded","get","undefined","findNotifier","notifiers","find","findRequest","entries","key","cancel","delete","SubscriptionsClient","socketUrl","options","PhoenixSocket","Map","phoenixSocket","disconnect","requestCompat","requestFromCompat","forEach"],"mappings":"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"}